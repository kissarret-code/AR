<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pontos Képfelismerő AR Alkalmazás</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #2c3e50, #1a237e);
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        h1 {
            text-align: center;
            color: #fff;
            margin-bottom: 20px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .instructions {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #4fc3f7;
            color: #e3f2fd;
        }
        
        .camera-container {
            position: relative;
            width: 100%;
            height: 400px;
            overflow: hidden;
            border-radius: 15px;
            margin-bottom: 20px;
            background: #000;
            box-shadow: 0 5px 25px rgba(0,0,0,0.5);
        }
        
        #video-element {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #canvas-element {
            display: none;
        }
        
        .detection-box {
            position: absolute;
            border: 3px solid #4caf50;
            border-radius: 5px;
            background: rgba(76, 175, 80, 0.2);
            z-index: 5;
            pointer-events: none;
        }
        
        .detection-label {
            position: absolute;
            background: rgba(76, 175, 80, 0.8);
            color: white;
            padding: 5px 8px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .overlay-image {
            position: absolute;
            width: 100px;
            height: auto;
            object-fit: contain;
            display: none;
            z-index: 10;
            border: 2px solid white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.9; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 0.9; }
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
        }
        
        .target-image {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 15px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        .target-image img {
            max-width: 200px;
            border: 2px solid #4a4a8a;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        button {
            padding: 15px 20px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(to right, #4a4a8a, #6e8efb);
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 10px rgba(0,0,0,0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin: 15px 0;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .detected {
            background: rgba(76, 175, 80, 0.3);
            color: #a5d6a7;
            animation: statusPulse 1.5s infinite;
        }
        
        .searching {
            background: rgba(255, 193, 7, 0.3);
            color: #ffe082;
        }
        
        .error {
            background: rgba(244, 67, 54, 0.3);
            color: #ffab91;
        }
        
        @keyframes statusPulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .info {
            background: rgba(3, 169, 244, 0.2);
            color: #b3e5fc;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .info ul {
            padding-left: 20px;
            margin-top: 10px;
        }
        
        .info li {
            margin-bottom: 8px;
        }
        
        .button-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .button-row button {
            flex: 1;
            min-width: 160px;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            margin: 20px 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(to right, #4caf50, #8bc34a);
            width: 0%;
            transition: width 0.5s;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .camera-container {
                height: 300px;
            }
            
            .button-row {
                flex-direction: column;
            }
            
            .button-row button {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <h1>Pontos AR Képfelismerő</h1>
    
    <div class="container">
        <div class="instructions">
            <p><strong>Használati útmutató:</strong> Engedélyezd a kamerához való hozzáférést. Az alkalmazás a TensorFlow.js segítségével valós idejű objektumfelismerést végez. Amikor a rendszer felismer egy objektumot, zöld keretezéssel és AR tartalommal jelzi.</p>
        </div>
        
        <div class="loading" id="loading">
            <p>Modell betöltése...</p>
            <div class="progress-bar">
                <div class="progress" id="progress"></div>
            </div>
        </div>
        
        <div class="camera-container">
            <video id="video-element" autoplay playsinline></video>
            <canvas id="canvas-element"></canvas>
            <!-- Detection boxes will be added here dynamically -->
        </div>
        
        <div id="status" class="status searching">Keresés objektumok után...</div>
        
        <div class="target-image">
            <h3>Példa felismerhető objektumok</h3>
            <p>Az alkalmazás az alábbi tárgyakat képes felismerni:</p>
            <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; justify-content: center;">
                <span style="background: rgba(76, 175, 80, 0.3); padding: 5px 10px; border-radius: 15px;">Telefon</span>
                <span style="background: rgba(76, 175, 80, 0.3); padding: 5px 10px; border-radius: 15px;">Kulcs</span>
                <span style="background: rgba(76, 175, 80, 0.3); padding: 5px 10px; border-radius: 15px;">Pohár</span>
                <span style="background: rgba(76, 175, 80, 0.3); padding: 5px 10px; border-radius: 15px;">Könyv</span>
                <span style="background: rgba(76, 175, 80, 0.3); padding: 5px 10px; border-radius: 15px;">Egér</span>
            </div>
        </div>
        
        <div class="controls">
            <div class="button-row">
                <button id="start-btn">Kamera indítása</button>
                <button id="switch-camera-btn">Kamera váltása</button>
                <button id="capture-btn">Kép rögzítése</button>
            </div>
            <div class="button-row">
                <button id="toggle-detection-btn">Objektumfelismerés ki</button>
                <button id="reset-btn">Visszaállítás</button>
            </div>
        </div>
        
        <div class="info">
            <p>Ez az alkalmazás a TensorFlow.js és a COCO-SSD modell segítségével valósítja meg a pontos objektumfelismerést. A modell a következőket képes felismerni:</p>
            <ul>
                <li>80 különböző objektumtípus</li>
                <li>Valós idejű felismerés (max. 5-10 FPS mobil eszközön)</li>
                <li>Pontos helymeghatározás keretezéssel</li>
            </ul>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const videoElement = document.getElementById('video-element');
            const canvasElement = document.getElementById('canvas-element');
            const statusDiv = document.getElementById('status');
            const startBtn = document.getElementById('start-btn');
            const switchCameraBtn = document.getElementById('switch-camera-btn');
            const toggleDetectionBtn = document.getElementById('toggle-detection-btn');
            const resetBtn = document.getElementById('reset-btn');
            const captureBtn = document.getElementById('capture-btn');
            const loadingDiv = document.getElementById('loading');
            const progressBar = document.getElementById('progress');
            
            let stream = null;
            let useFrontCamera = false; // Default to back camera for object detection
            let model = null;
            let detectionInterval = null;
            let isDetecting = false;
            let detectedObjects = [];
            
            // Betöltési folyamat szimulálása
            async function simulateLoading() {
                for (let i = 0; i <= 100; i++) {
                    progressBar.style.width = i + '%';
                    await new Promise(resolve => setTimeout(resolve, 30));
                }
                loadingDiv.style.display = 'none';
            }
            
            // TensorFlow.js modell betöltése
            async function loadModel() {
                try {
                    statusDiv.textContent = "Modell betöltése...";
                    statusDiv.className = "status searching";
                    
                    // COCO-SSD modell betöltése
                    model = await cocoSsd.load();
                    
                    statusDiv.textContent = "Modell betöltve. Kamera indítása...";
                    await startCamera();
                    
                } catch (error) {
                    console.error("Hiba a modell betöltésekor:", error);
                    statusDiv.textContent = "Hiba: " + error.message;
                    statusDiv.className = "status error";
                }
            }
            
            // Kamera indítása
            async function startCamera() {
                statusDiv.textContent = "Kamera indítása...";
                statusDiv.className = "status searching";
                
                try {
                    // Meglévő stream leállítása
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                    }
                    
                    // Kamera kiválasztása
                    const constraints = {
                        video: {
                            facingMode: useFrontCamera ? "user" : "environment",
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        }
                    };
                    
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                    videoElement.srcObject = stream;
                    
                    // Kamera típusa alapján beállítjuk a tükrözést
                    if (useFrontCamera) {
                        videoElement.style.transform = "scaleX(-1)"; // Elülső kamera - tükrözés
                    } else {
                        videoElement.style.transform = "scaleX(1)"; // Hátsó kamera - nincs tükrözés
                    }
                    
                    statusDiv.textContent = "Kamera elérve. Objektumok felismerése...";
                    
                    // Objektumfelismerés indítása
                    startObjectDetection();
                    
                } catch (error) {
                    console.error("Hiba a kamera indításakor:", error);
                    statusDiv.textContent = "Hiba: " + error.message;
                    statusDiv.className = "status error";
                }
            }
            
            // Objektumfelismerés indítása
            function startObjectDetection() {
                if (detectionInterval) {
                    clearInterval(detectionInterval);
                }
                
                isDetecting = true;
                toggleDetectionBtn.textContent = "Objektumfelismerés ki";
                
                // Objektumok felismerése rendszeres időközönként
                detectionInterval = setInterval(async () => {
                    if (model && isDetecting) {
                        detectObjects();
                    }
                }, 500); // 2 FPS (mobil eszközökön a teljesítmény miatt)
            }
            
            // Objektumok felismerése
            async function detectObjects() {
                if (!model || !isDetecting) return;
                
                try {
                    // Objektumok felismerése a videóban
                    const predictions = await model.detect(videoElement);
                    
                    // Előző detektálási eredmények törlése
                    clearDetections();
                    
                    if (predictions.length > 0) {
                        detectedObjects = predictions;
                        displayDetections(predictions);
                        
                        statusDiv.textContent = `${predictions.length} objektum felismerve`;
                        statusDiv.className = "status detected";
                    } else {
                        statusDiv.textContent = "Keresés objektumok után...";
                        statusDiv.className = "status searching";
                    }
                } catch (error) {
                    console.error("Hiba az objektumfelismerés során:", error);
                }
            }
            
            // Detektált objektumok megjelenítése
            function displayDetections(predictions) {
                const videoWidth = videoElement.videoWidth;
                const videoHeight = videoElement.videoHeight;
                const container = document.querySelector('.camera-container');
                
                predictions.forEach(prediction => {
                    const [x, y, width, height] = prediction.bbox;
                    
                    // Skálázás a videó méretéhez
                    const scaleX = videoElement.offsetWidth / videoWidth;
                    const scaleY = videoElement.offsetHeight / videoHeight;
                    
                    // Detektálási doboz
                    const box = document.createElement('div');
                    box.className = 'detection-box';
                    box.style.left = `${x * scaleX}px`;
                    box.style.top = `${y * scaleY}px`;
                    box.style.width = `${width * scaleX}px`;
                    box.style.height = `${height * scaleY}px`;
                    
                    // Címke
                    const label = document.createElement('div');
                    label.className = 'detection-label';
                    label.textContent = `${prediction.class} (${Math.round(prediction.score * 100)}%)`;
                    label.style.left = `${x * scaleX}px`;
                    label.style.top = `${(y * scaleY) - 25}px`;
                    
                    container.appendChild(box);
                    container.appendChild(label);
                    
                    // AR overlay hozzáadása a fontosabb objektumokhoz
                    if (prediction.score > 0.7 && ['cell phone', 'book', 'cup', 'keyboard', 'mouse'].includes(prediction.class)) {
                        addAROverlay(x * scaleX, y * scaleY, width * scaleX, height * scaleY, prediction.class);
                    }
                });
            }
            
            // AR overlay hozzáadása
            function addAROverlay(x, y, width, height, className) {
                const overlay = document.createElement('img');
                overlay.className = 'overlay-image';
                overlay.style.display = 'block';
                overlay.style.left = `${x + width/2}px`;
                overlay.style.top = `${y}px`;
                overlay.style.transform = 'translate(-50%, -100%)';
                
                // Különböző overlay-ek különböző objektumokhoz
                if (className === 'cell phone') {
                    overlay.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzRlNGE4YSIgcng9IjEwIiByeT0iMTAiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSI+VEVMRUZPTjwvdGV4dD48L3N2Zz4=';
                } else if (className === 'book') {
                    overlay.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzYlOEUmQiIgcng9IjEwIiByeT0iMTAiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSI+S8OWTkWVPC90ZXh0Pjwvc3ZnPg==';
                } else {
                    overlay.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2E3NzdlMyIgcng9IjEwIiByeT0iMTAiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSI+QVIgS0VQPC90ZXh0Pjwvc3ZnPg==';
                }
                
                document.querySelector('.camera-container').appendChild(overlay);
            }
            
            // Detektálások törlése
            function clearDetections() {
                const boxes = document.querySelectorAll('.detection-box, .detection-label, .overlay-image');
                boxes.forEach(box => box.remove());
            }
            
            // Kamera váltása
            switchCameraBtn.addEventListener('click', function() {
                useFrontCamera = !useFrontCamera;
                startCamera();
            });
            
            // Objektumfelismerés ki/be kapcsolása
            toggleDetectionBtn.addEventListener('click', function() {
                isDetecting = !isDetecting;
                
                if (isDetecting) {
                    toggleDetectionBtn.textContent = "Objektumfelismerés ki";
                    startObjectDetection();
                    statusDiv.textContent = "Objektumok felismerése...";
                    statusDiv.className = "status searching";
                } else {
                    toggleDetectionBtn.textContent = "Objektumfelismerés be";
                    clearInterval(detectionInterval);
                    clearDetections();
                    statusDiv.textContent = "Objektumfelismerés kikapcsolva";
                    statusDiv.className = "status";
                }
            });
            
            // Kamera indítása gomb
            startBtn.addEventListener('click', startCamera);
            
            // Kép rögzítése
            captureBtn.addEventListener('click', function() {
                const context = canvasElement.getContext('2d');
                canvasElement.width = videoElement.videoWidth;
                canvasElement.height = videoElement.videoHeight;
                
                // A tükrözést figyelembe véve rajzoljuk meg a képet
                if (useFrontCamera) {
                    context.translate(canvasElement.width, 0);
                    context.scale(-1, 1);
                    context.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
                    context.setTransform(1, 0, 0, 1, 0, 0); // Reset transform
                } else {
                    context.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
                }
                
                // Detektálási dobozok hozzáadása
                detectedObjects.forEach(prediction => {
                    const [x, y, width, height] = prediction.bbox;
                    context.strokeStyle = '#4caf50';
                    context.lineWidth = 3;
                    context.strokeRect(x, y, width, height);
                    
                    context.fillStyle = 'rgba(76, 175, 80, 0.8)';
                    context.font = '16px Arial';
                    context.fillText(`${prediction.class} (${Math.round(prediction.score * 100)}%)`, x, y > 20 ? y - 5 : 15);
                });
                
                // Kép letöltése
                const dataUrl = canvasElement.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = 'object_detection.png';
                link.href = dataUrl;
                link.click();
                
                statusDiv.textContent = "Kép rögzítve és letöltve!";
                statusDiv.className = "status detected";
                
                setTimeout(() => {
                    statusDiv.textContent = "Objektumok felismerése...";
                    statusDiv.className = "status searching";
                }, 3000);
            });
            
            // Visszaállítás gomb
            resetBtn.addEventListener('click', function() {
                clearDetections();
                statusDiv.textContent = "Objektumok felismerése...";
                statusDiv.className = "status searching";
                startObjectDetection();
            });
            
            // Oldal betöltése
            simulateLoading();
            await loadModel();
        });
    </script>
</body>
</html>
