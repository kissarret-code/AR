<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kutyafelismer≈ë AR Alkalmaz√°s</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6d4c41, #a1887f);
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        h1 {
            text-align: center;
            color: #fff;
            margin-bottom: 20px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .instructions {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #ffab91;
            color: #ffccbc;
        }
        
        .camera-container {
            position: relative;
            width: 100%;
            height: 400px;
            overflow: hidden;
            border-radius: 15px;
            margin-bottom: 20px;
            background: #000;
            box-shadow: 0 5px 25px rgba(0,0,0,0.5);
        }
        
        #video-element {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #canvas-element {
            display: none;
        }
        
        .detection-box {
            position: absolute;
            border: 3px solid #ffab91;
            border-radius: 5px;
            background: rgba(255, 171, 145, 0.2);
            z-index: 5;
            pointer-events: none;
        }
        
        .detection-label {
            position: absolute;
            background: rgba(255, 171, 145, 0.9);
            color: #5d4037;
            padding: 5px 8px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .overlay-image {
            position: absolute;
            width: 150px;
            height: auto;
            object-fit: contain;
            display: none;
            z-index: 10;
            border: 2px solid white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.9; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 0.9; }
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
        }
        
        .target-image {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 15px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        .target-image img {
            max-width: 250px;
            border: 3px solid #ffab91;
            border-radius: 10px;
            margin-top: 10px;
        }
        
        button {
            padding: 15px 20px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(to right, #ffab91, #ff8a65);
            color: #5d4037;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            font-weight: bold;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 10px rgba(0,0,0,0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin: 15px 0;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .detected {
            background: rgba(255, 171, 145, 0.3);
            color: #ffccbc;
            animation: statusPulse 1.5s infinite;
        }
        
        .searching {
            background: rgba(255, 193, 7, 0.3);
            color: #ffe082;
        }
        
        .error {
            background: rgba(244, 67, 54, 0.3);
            color: #ffab91;
        }
        
        @keyframes statusPulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .info {
            background: rgba(255, 171, 145, 0.2);
            color: #ffccbc;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .info ul {
            padding-left: 20px;
            margin-top: 10px;
        }
        
        .info li {
            margin-bottom: 8px;
        }
        
        .button-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .button-row button {
            flex: 1;
            min-width: 160px;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            margin: 20px 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(to right, #ffab91, #ff8a65);
            width: 0%;
            transition: width 0.5s;
        }
        
        .dog-facts {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-style: italic;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .camera-container {
                height: 300px;
            }
            
            .button-row {
                flex-direction: column;
            }
            
            .button-row button {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <h1>Kutyafelismer≈ë AR Alkalmaz√°s</h1>
    
    <div class="container">
        <div class="instructions">
            <p><strong>Haszn√°lati √∫tmutat√≥:</strong> Enged√©lyezd a kamer√°hoz val√≥ hozz√°f√©r√©st. Az alkalmaz√°s a TensorFlow.js seg√≠ts√©g√©vel kiz√°r√≥lag kuty√°kat ismer fel. Amikor a rendszer felismer egy kuty√°t, narancss√°rga keretez√©ssel √©s egy speci√°lis k√©ppel jelzi.</p>
        </div>
        
        <div class="loading" id="loading">
            <p>Kutyafelismer≈ë modell bet√∂lt√©se...</p>
            <div class="progress-bar">
                <div class="progress" id="progress"></div>
            </div>
        </div>
        
        <div class="camera-container">
            <video id="video-element" autoplay playsinline></video>
            <canvas id="canvas-element"></canvas>
            <!-- Detection boxes will be added here dynamically -->
        </div>
        
        <div id="status" class="status searching">Keres√©s kuty√°k ut√°n...</div>
        
        <div class="target-image">
            <h3>Felismerend≈ë k√©p - Amikor egy kuty√°t √©szlel</h3>
            <img id="target-img" src="https://www.dogsforgood.org/wp-content/uploads/2020/10/good-advice-puppy-play-bow.jpg" alt="Kutya AR k√©p" onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2ZmYWI5MSIgcng9IjEwIiByeT0iMTAiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjNWQ0MDM3Ij5LVVRZQSBLLlQuPC90ZXh0Pjwvc3ZnPg=='">
        </div>
        
        <div class="controls">
            <div class="button-row">
                <button id="start-btn">Kamera ind√≠t√°sa</button>
                <button id="switch-camera-btn">Kamera v√°lt√°sa</button>
                <button id="capture-btn">K√©p r√∂gz√≠t√©se</button>
            </div>
            <div class="button-row">
                <button id="toggle-detection-btn">Kutyakeres√©s ki</button>
                <button id="reset-btn">Vissza√°ll√≠t√°s</button>
            </div>
        </div>
        
        <div class="dog-facts">
            <p>üí° Tudtad, hogy a kuty√°k k√∂r√ºlbel√ºl 225-250 sz√≥t √©s gesztust meg tudnak tanulni? Ez megfelel egy 2-3 √©ves gyerek nyelvi k√©pess√©geinek.</p>
        </div>
        
        <div class="info">
            <p>Ez az alkalmaz√°s a TensorFlow.js √©s a COCO-SSD modell seg√≠ts√©g√©vel val√≥s√≠tja meg a kutyafelismer√©st. A modell a k√∂vetkez≈ëket k√©pes felismerni:</p>
            <ul>
                <li>K√ºl√∂nb√∂z≈ë kutyafajt√°kat</li>
                <li>Val√≥s idej≈± felismer√©s</li>
                <li>Pontos helymeghat√°roz√°s keretez√©ssel</li>
            </ul>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const videoElement = document.getElementById('video-element');
            const canvasElement = document.getElementById('canvas-element');
            const statusDiv = document.getElementById('status');
            const startBtn = document.getElementById('start-btn');
            const switchCameraBtn = document.getElementById('switch-camera-btn');
            const toggleDetectionBtn = document.getElementById('toggle-detection-btn');
            const resetBtn = document.getElementById('reset-btn');
            const captureBtn = document.getElementById('capture-btn');
            const loadingDiv = document.getElementById('loading');
            const progressBar = document.getElementById('progress');
            const targetImg = document.getElementById('target-img');
            
            let stream = null;
            let useFrontCamera = false; // Default to back camera for object detection
            let model = null;
            let detectionInterval = null;
            let isDetecting = false;
            let detectedDogs = [];
            let dogOverlay = null;
            
            // Bet√∂lt√©si folyamat szimul√°l√°sa
            async function simulateLoading() {
                for (let i = 0; i <= 100; i++) {
                    progressBar.style.width = i + '%';
                    await new Promise(resolve => setTimeout(resolve, 30));
                }
                loadingDiv.style.display = 'none';
            }
            
            // TensorFlow.js modell bet√∂lt√©se
            async function loadModel() {
                try {
                    statusDiv.textContent = "Kutyafelismer≈ë modell bet√∂lt√©se...";
                    statusDiv.className = "status searching";
                    
                    // COCO-SSD modell bet√∂lt√©se
                    model = await cocoSsd.load();
                    
                    statusDiv.textContent = "Modell bet√∂ltve. Kamera ind√≠t√°sa...";
                    await startCamera();
                    
                } catch (error) {
                    console.error("Hiba a modell bet√∂lt√©sekor:", error);
                    statusDiv.textContent = "Hiba: " + error.message;
                    statusDiv.className = "status error";
                }
            }
            
            // Kamera ind√≠t√°sa
            async function startCamera() {
                statusDiv.textContent = "Kamera ind√≠t√°sa...";
                statusDiv.className = "status searching";
                
                try {
                    // Megl√©v≈ë stream le√°ll√≠t√°sa
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                    }
                    
                    // Kamera kiv√°laszt√°sa
                    const constraints = {
                        video: {
                            facingMode: useFrontCamera ? "user" : "environment",
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        }
                    };
                    
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                    videoElement.srcObject = stream;
                    
                    // Kamera t√≠pusa alapj√°n be√°ll√≠tjuk a t√ºkr√∂z√©st
                    if (useFrontCamera) {
                        videoElement.style.transform = "scaleX(-1)"; // El√ºls≈ë kamera - t√ºkr√∂z√©s
                    } else {
                        videoElement.style.transform = "scaleX(1)"; // H√°ts√≥ kamera - nincs t√ºkr√∂z√©s
                    }
                    
                    statusDiv.textContent = "Kamera el√©rve. Kuty√°k keres√©se...";
                    
                    // Kutyakeres√©s ind√≠t√°sa
                    startDogDetection();
                    
                } catch (error) {
                    console.error("Hiba a kamera ind√≠t√°sakor:", error);
                    statusDiv.textContent = "Hiba: " + error.message;
                    statusDiv.className = "status error";
                }
            }
            
            // Kutyakeres√©s ind√≠t√°sa
            function startDogDetection() {
                if (detectionInterval) {
                    clearInterval(detectionInterval);
                }
                
                isDetecting = true;
                toggleDetectionBtn.textContent = "Kutyakeres√©s ki";
                
                // Kuty√°k felismer√©se rendszeres id≈ëk√∂z√∂nk√©nt
                detectionInterval = setInterval(async () => {
                    if (model && isDetecting) {
                        detectDogs();
                    }
                }, 800); // Cs√∂kkentett FPS a teljes√≠tm√©ny √©rdek√©ben
            }
            
            // Kuty√°k felismer√©se
            async function detectDogs() {
                if (!model || !isDetecting) return;
                
                try {
                    // Objektumok felismer√©se a vide√≥ban
                    const predictions = await model.detect(videoElement);
                    
                    // El≈ëz≈ë detekt√°l√°si eredm√©nyek t√∂rl√©se
                    clearDetections();
                    
                    // Csak kuty√°k sz≈±r√©se
                    const dogs = predictions.filter(prediction => 
                        prediction.class === 'dog' && prediction.score > 0.6
                    );
                    
                    if (dogs.length > 0) {
                        detectedDogs = dogs;
                        displayDetections(dogs);
                        
                        statusDiv.textContent = `${dogs.length} kutya felismerve!`;
                        statusDiv.className = "status detected";
                        
                        // AR overlay megjelen√≠t√©se
                        showDogOverlay(dogs[0]);
                    } else {
                        statusDiv.textContent = "Keres√©s kuty√°k ut√°n...";
                        statusDiv.className = "status searching";
                        
                        // AR overlay elrejt√©se
                        hideDogOverlay();
                    }
                } catch (error) {
                    console.error("Hiba a kutya felismer√©se sor√°n:", error);
                }
            }
            
            // Detekt√°lt kuty√°k megjelen√≠t√©se
            function displayDetections(dogs) {
                const videoWidth = videoElement.videoWidth;
                const videoHeight = videoElement.videoHeight;
                const container = document.querySelector('.camera-container');
                
                dogs.forEach(dog => {
                    const [x, y, width, height] = dog.bbox;
                    
                    // Sk√°l√°z√°s a vide√≥ m√©ret√©hez
                    const scaleX = videoElement.offsetWidth / videoWidth;
                    const scaleY = videoElement.offsetHeight / videoHeight;
                    
                    // Detekt√°l√°si doboz
                    const box = document.createElement('div');
                    box.className = 'detection-box';
                    box.style.left = `${x * scaleX}px`;
                    box.style.top = `${y * scaleY}px`;
                    box.style.width = `${width * scaleX}px`;
                    box.style.height = `${height * scaleY}px`;
                    
                    // C√≠mke
                    const label = document.createElement('div');
                    label.className = 'detection-label';
                    label.textContent = `Kutya (${Math.round(dog.score * 100)}%)`;
                    label.style.left = `${x * scaleX}px`;
                    label.style.top = `${(y * scaleY) - 25}px`;
                    
                    container.appendChild(box);
                    container.appendChild(label);
                });
            }
            
            // AR overlay megjelen√≠t√©se kuty√°hoz
            function showDogOverlay(dog) {
                const videoWidth = videoElement.videoWidth;
                const videoHeight = videoElement.videoHeight;
                const container = document.querySelector('.camera-container');
                
                const [x, y, width, height] = dog.bbox;
                
                // Sk√°l√°z√°s a vide√≥ m√©ret√©hez
                const scaleX = videoElement.offsetWidth / videoWidth;
                const scaleY = videoElement.offsetHeight / videoHeight;
                
                // AR overlay l√©trehoz√°sa vagy friss√≠t√©se
                if (!dogOverlay) {
                    dogOverlay = document.createElement('img');
                    dogOverlay.className = 'overlay-image';
                    dogOverlay.src = targetImg.src;
                    container.appendChild(dogOverlay);
                }
                
                // Overlay pozicion√°l√°sa a kutya felett
                dogOverlay.style.display = 'block';
                dogOverlay.style.left = `${x * scaleX + (width * scaleX)/2}px`;
                dogOverlay.style.top = `${y * scaleY - 10}px`;
                dogOverlay.style.transform = 'translate(-50%, -100%)';
            }
            
            // AR overlay elrejt√©se
            function hideDogOverlay() {
                if (dogOverlay) {
                    dogOverlay.style.display = 'none';
                }
            }
            
            // Detekt√°l√°sok t√∂rl√©se
            function clearDetections() {
                const boxes = document.querySelectorAll('.detection-box, .detection-label');
                boxes.forEach(box => box.remove());
            }
            
            // Kamera v√°lt√°sa
            switchCameraBtn.addEventListener('click', function() {
                useFrontCamera = !useFrontCamera;
                startCamera();
            });
            
            // Kutyakeres√©s ki/be kapcsol√°sa
            toggleDetectionBtn.addEventListener('click', function() {
                isDetecting = !isDetecting;
                
                if (isDetecting) {
                    toggleDetectionBtn.textContent = "Kutyakeres√©s ki";
                    startDogDetection();
                    statusDiv.textContent = "Kuty√°k keres√©se...";
                    statusDiv.className = "status searching";
                } else {
                    toggleDetectionBtn.textContent = "Kutyakeres√©s be";
                    clearInterval(detectionInterval);
                    clearDetections();
                    hideDogOverlay();
                    statusDiv.textContent = "Kutyakeres√©s kikapcsolva";
                    statusDiv.className = "status";
                }
            });
            
            // Kamera ind√≠t√°sa gomb
            startBtn.addEventListener('click', startCamera);
            
            // K√©p r√∂gz√≠t√©se
            captureBtn.addEventListener('click', function() {
                const context = canvasElement.getContext('2d');
                canvasElement.width = videoElement.videoWidth;
                canvasElement.height = videoElement.videoHeight;
                
                // A t√ºkr√∂z√©st figyelembe v√©ve rajzoljuk meg a k√©pet
                if (useFrontCamera) {
                    context.translate(canvasElement.width, 0);
                    context.scale(-1, 1);
                    context.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
                    context.setTransform(1, 0, 0, 1, 0, 0); // Reset transform
                } else {
                    context.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
                }
                
                // Detekt√°l√°si dobozok hozz√°ad√°sa
                detectedDogs.forEach(dog => {
                    const [x, y, width, height] = dog.bbox;
                    context.strokeStyle = '#ffab91';
                    context.lineWidth = 3;
                    context.strokeRect(x, y, width, height);
                    
                    context.fillStyle = 'rgba(255, 171, 145, 0.8)';
                    context.font = '16px Arial';
                    context.fillText(`Kutya (${Math.round(dog.score * 100)}%)`, x, y > 20 ? y - 5 : 15);
                });
                
                // K√©p let√∂lt√©se
                const dataUrl = canvasElement.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = 'kutya_felismeres.png';
                link.href = dataUrl;
                link.click();
                
                statusDiv.textContent = "Kutya k√©pe r√∂gz√≠tve!";
                statusDiv.className = "status detected";
                
                setTimeout(() => {
                    statusDiv.textContent = "Kuty√°k keres√©se...";
                    statusDiv.className = "status searching";
                }, 3000);
            });
            
            // Vissza√°ll√≠t√°s gomb
            resetBtn.addEventListener('click', function() {
                clearDetections();
                hideDogOverlay();
                statusDiv.textContent = "Kuty√°k keres√©se...";
                statusDiv.className = "status searching";
                startDogDetection();
            });
            
            // Oldal bet√∂lt√©se
            simulateLoading();
            await loadModel();
        });
    </script>
</body>
</html>
